<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>창작 공간</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* 카테고리 색상 */
        .category-novel { background-color: #3b82f6; }
        .category-poem { background-color: #ec4899; }
        .category-diary { background-color: #10b981; }
        .category-essay { background-color: #8b5cf6; }
        .category-idea { background-color: #f59e0b; }
        .category-script { background-color: #ef4444; }
        
        .category-novel-light { background-color: #eff6ff; color: #1d4ed8; border-color: #bfdbfe; }
        .category-poem-light { background-color: #fdf2f8; color: #be185d; border-color: #fbcfe8; }
        .category-diary-light { background-color: #ecfdf5; color: #047857; border-color: #bbf7d0; }
        .category-essay-light { background-color: #f3e8ff; color: #6d28d9; border-color: #ddd6fe; }
        .category-idea-light { background-color: #fffbeb; color: #92400e; border-color: #fed7aa; }
        .category-script-light { background-color: #fef2f2; color: #b91c1c; border-color: #fecaca; }
        
        /* 모바일 최적화 스타일 */
        body {
            overscroll-behavior-y: contain; /* 모바일에서 당겨서 새로고침 방지 */
            -webkit-tap-highlight-color: transparent; /* 탭 하이라이트 제거 */
            touch-action: manipulation; /* 더블탭 줌 방지 */
        }
        
        /* 모바일에서 터치 영역 확대 */
        button, select, input[type="text"], textarea {
            min-height: 44px; /* 애플 권장 최소 터치 영역 */
        }
        
        /* 플로팅 메뉴 모바일 최적화 */
        .floating-menu {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s, transform 0.2s;
            transform: translateY(10px);
        }
        
        .floating-button.active .floating-menu {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }
        
        /* 모바일에서 스크롤 최적화 */
        .mobile-scroll {
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }
        
        /* 텍스트 줄임 */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* 탭 스타일 */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .tab-button {
            position: relative;
            padding: 0.75rem 0;
            width: 33.333%;
            text-align: center;
        }
        
        .tab-button.active {
            color: #3b82f6;
            font-weight: 500;
        }
        
        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 25%;
            width: 50%;
            height: 2px;
            background-color: #3b82f6;
        }
        
        /* 모바일 키보드 대응 */
        @media (max-width: 640px) {
            .keyboard-adjust {
                padding-bottom: 40vh; /* 키보드 높이 대응 */
            }
        }
        
        /* 모바일 스크롤 영역 */
        .posts-container {
            height: calc(100vh - 220px);
            overflow-y: auto;
        }
        
        /* 모바일 입력 필드 포커스 시 확대 방지 */
        @media (max-width: 640px) {
            input, textarea, select {
                font-size: 16px; /* iOS에서 자동 확대 방지 */
            }
        }
        
        /* 모바일 터치 피드백 */
        .touch-feedback:active {
            background-color: rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <!-- Navigation Bar -->
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-10 shadow-sm">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center h-14">
                <div class="flex items-center">
                    <button id="backButton" class="mr-2 w-10 h-10 flex items-center justify-center text-gray-600 hover:text-gray-900 hidden" onclick="goBackToList()" aria-label="뒤로 가기">
                        <i class="fas fa-arrow-left text-lg"></i>
                    </button>
                    <h1 class="text-xl font-bold text-gray-900">창작 공간</h1>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-4">
        <!-- List View -->
        <div id="listView">
            <div class="mb-4">
                <h2 class="text-xl font-bold text-gray-900 mb-1">내 작품들</h2>
                <p class="text-sm text-gray-600">창작한 작품들을 관리하고 편집하세요</p>
            </div>

            <!-- Category Filter -->
            <div class="mb-4">
                <div class="flex items-center gap-2 mb-3">
                    <i class="fas fa-filter text-gray-500"></i>
                    <select id="categoryFilter" class="flex-1 px-3 h-12 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white" onchange="filterByCategory()">
                        <option value="전체">전체 카테고리</option>
                        <option value="소설">소설</option>
                        <option value="시">시</option>
                        <option value="일기">일기</option>
                        <option value="에세이">에세이</option>
                        <option value="아이디어">아이디어</option>
                        <option value="대본">대본</option>
                    </select>
                </div>

                <!-- Category Quick Stats -->
                <div class="grid grid-cols-3 sm:grid-cols-6 gap-2" id="categoryStats">
                    <!-- 카테고리 통계가 여기에 동적으로 생성됩니다 -->
                </div>
            </div>

            <!-- Posts List -->
            <div class="posts-container mobile-scroll pb-20">
                <div class="grid gap-3" id="postsList">
                    <!-- 작품 목록이 여기에 동적으로 생성됩니다 -->
                </div>
            </div>

            <!-- Floating Action Button -->
            <div class="fixed bottom-6 right-6 z-20">
                <div class="floating-button" id="floatingButton">
                    <button 
                        class="h-14 w-14 bg-blue-500 hover:bg-blue-600 text-white rounded-full shadow-lg flex items-center justify-center"
                        onclick="toggleFloatingMenu()"
                        aria-label="새 작품 쓰기"
                    >
                        <i class="fas fa-plus text-xl"></i>
                    </button>
                    
                    <!-- Category Selection Menu -->
                    <div class="floating-menu absolute bottom-16 right-0 bg-white rounded-lg shadow-lg border border-gray-200 p-2 w-64 sm:w-48">
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="startNewPiece('소설'); hideFloatingMenu();" class="flex items-center gap-2 px-3 py-3 text-left hover:bg-gray-100 rounded touch-feedback">
                                <div class="w-8 h-8 rounded-full category-novel flex items-center justify-center">
                                    <i class="fas fa-book text-white"></i>
                                </div>
                                <span class="text-sm">소설</span>
                            </button>
                            <button onclick="startNewPiece('시'); hideFloatingMenu();" class="flex items-center gap-2 px-3 py-3 text-left hover:bg-gray-100 rounded touch-feedback">
                                <div class="w-8 h-8 rounded-full category-poem flex items-center justify-center">
                                    <i class="fas fa-heart text-white"></i>
                                </div>
                                <span class="text-sm">시</span>
                            </button>
                            <button onclick="startNewPiece('일기'); hideFloatingMenu();" class="flex items-center gap-2 px-3 py-3 text-left hover:bg-gray-100 rounded touch-feedback">
                                <div class="w-8 h-8 rounded-full category-diary flex items-center justify-center">
                                    <i class="fas fa-calendar text-white"></i>
                                </div>
                                <span class="text-sm">일기</span>
                            </button>
                            <button onclick="startNewPiece('에세이'); hideFloatingMenu();" class="flex items-center gap-2 px-3 py-3 text-left hover:bg-gray-100 rounded touch-feedback">
                                <div class="w-8 h-8 rounded-full category-essay flex items-center justify-center">
                                    <i class="fas fa-file-alt text-white"></i>
                                </div>
                                <span class="text-sm">에세이</span>
                            </button>
                            <button onclick="startNewPiece('아이디어'); hideFloatingMenu();" class="flex items-center gap-2 px-3 py-3 text-left hover:bg-gray-100 rounded touch-feedback">
                                <div class="w-8 h-8 rounded-full category-idea flex items-center justify-center">
                                    <i class="fas fa-lightbulb text-white"></i>
                                </div>
                                <span class="text-sm">아이디어</span>
                            </button>
                            <button onclick="startNewPiece('대본'); hideFloatingMenu();" class="flex items-center gap-2 px-3 py-3 text-left hover:bg-gray-100 rounded touch-feedback">
                                <div class="w-8 h-8 rounded-full category-script flex items-center justify-center">
                                    <i class="fas fa-theater-masks text-white"></i>
                                </div>
                                <span class="text-sm">대본</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Editor View -->
        <div id="editorView" class="hidden pb-20 keyboard-adjust">
            <div class="mb-4">
                <div class="flex items-center gap-3 mb-2">
                    <div id="editorCategoryIcon" class="w-10 h-10 rounded-full flex items-center justify-center">
                        <i class="text-white text-lg"></i>
                    </div>
                    <h2 id="editorTitle" class="text-xl font-bold text-gray-900">새 작품 쓰기</h2>
                </div>
                <p id="editorGuide" class="text-sm text-gray-600">창작 가이드가 여기에 표시됩니다.</p>
            </div>

            <div class="bg-white border border-gray-200 shadow-sm rounded-lg">
                <div class="p-4 space-y-5">
                    <!-- Category Selection -->
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-gray-700">카테고리</label>
                        <select id="pieceCategory" class="w-full px-3 h-12 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white" onchange="updateEditorCategory()">
                            <option value="소설">소설</option>
                            <option value="시">시</option>
                            <option value="일기">일기</option>
                            <option value="에세이">에세이</option>
                            <option value="아이디어">아이디어</option>
                            <option value="대본">대본</option>
                        </select>
                    </div>

                    <!-- Title -->
                    <div class="space-y-2">
                        <label for="pieceTitle" class="text-sm font-medium text-gray-700">제목</label>
                        <input type="text" id="pieceTitle" class="w-full px-3 h-12 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-base" placeholder="제목을 입력하세요...">
                    </div>

                    <!-- Tabs -->
                    <div class="w-full">
                        <div class="flex border-b border-gray-200">
                            <button class="tab-button active" onclick="switchTab('content')">내용</button>
                            <button class="tab-button" onclick="switchTab('details')">세부사항</button>
                            <button class="tab-button" onclick="switchTab('meta')">메타정보</button>
                        </div>

                        <!-- Content Tab -->
                        <div id="contentTab" class="tab-content active pt-4">
                            <div class="space-y-2">
                                <label for="pieceContent" class="text-sm font-medium text-gray-700">내용</label>
                                <textarea id="pieceContent" class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none" rows="12" placeholder="내용을 입력하세요..." oninput="updateCharCount()"></textarea>
                                <p id="charCount" class="text-sm text-gray-500">0자 작성됨</p>
                            </div>
                        </div>

                        <!-- Details Tab -->
                        <div id="detailsTab" class="tab-content pt-4 space-y-4">
                            <div id="moodSection" class="space-y-2">
                                <label class="text-sm font-medium text-gray-700">기분/분위기</label>
                                <input type="text" id="pieceMood" class="w-full px-3 h-12 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="오늘의 기분이나 작품의 분위기를 입력하세요">
                            </div>
                            
                            <div id="charactersSection" class="space-y-2">
                                <label class="text-sm font-medium text-gray-700">등장인물</label>
                                <div class="flex gap-2">
                                    <input type="text" id="newCharacter" class="flex-1 px-3 h-12 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="등장인물 이름" onkeydown="if(event.key==='Enter') addCharacter()">
                                    <button type="button" onclick="addCharacter()" class="px-4 h-12 bg-blue-500 text-white rounded-lg hover:bg-blue-600">추가</button>
                                </div>
                                <div id="charactersList" class="flex flex-wrap gap-2 pt-2">
                                    <!-- 등장인물 태그들이 여기에 표시됩니다 -->
                                </div>
                            </div>
                        </div>

                        <!-- Meta Tab -->
                        <div id="metaTab" class="tab-content pt-4 space-y-4">
                            <div class="space-y-2">
                                <label class="text-sm font-medium text-gray-700">태그</label>
                                <div class="flex gap-2">
                                    <input type="text" id="newTag" class="flex-1 px-3 h-12 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="태그 입력" onkeydown="if(event.key==='Enter') addTag()">
                                    <button type="button" onclick="addTag()" class="px-4 h-12 bg-blue-500 text-white rounded-lg hover:bg-blue-600">추가</button>
                                </div>
                                <div id="tagsList" class="flex flex-wrap gap-2 pt-2">
                                    <!-- 태그들이 여기에 표시됩니다 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-3 flex gap-3 z-10">
                <button onclick="cancelEdit()" class="flex-1 h-12 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 flex items-center justify-center">
                    <i class="fas fa-times mr-2"></i>취소
                </button>
                <button onclick="savePiece()" class="flex-1 h-12 bg-blue-500 text-white rounded-lg hover:bg-blue-600 flex items-center justify-center">
                    <i class="fas fa-save mr-2"></i><span id="saveButtonText">저장</span>
                </button>
            </div>
        </div>
    </main>

    <!-- 모바일 오버레이 -->
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-10 hidden" onclick="hideFloatingMenu()"></div>

    <script>
        // 전역 변수들
        let pieces = [
            {
                id: "1",
                title: "첫 번째 소설",
                content: "어둠이 내린 골목길에서 그녀는 운명적인 만남을 가졌다...",
                preview: "어둠이 내린 골목길에서 그녀는 운명적인 만남을 가졌다...",
                category: "소설",
                createdAt: "2024-01-15",
                characters: ["주인공", "신비한 남자"]
            },
            {
                id: "2",
                title: "봄날의 기억",
                content: "벚꽃이 흩날리는 / 그 길에서 / 너를 만났다",
                preview: "벚꽃이 흩날리는 / 그 길에서 / 너를 만났다",
                category: "시",
                createdAt: "2024-01-10",
                mood: "그리움"
            },
            {
                id: "3",
                title: "오늘의 하루",
                content: "오늘은 정말 바쁜 하루였다. 아침부터 회의가 연달아 있었고...",
                preview: "오늘은 정말 바쁜 하루였다. 아침부터 회의가 연달아 있었고...",
                category: "일기",
                createdAt: "2024-01-05",
                mood: "피곤함"
            }
        ];

        let currentEditingPiece = null;
        let currentFilter = "전체";

        const categoryConfig = {
            "소설": {
                icon: "fas fa-book",
                color: "category-novel",
                lightColor: "category-novel-light",
                placeholder: "이야기의 시작을 써보세요...",
                guide: "인물, 배경, 갈등을 중심으로 이야기를 전개해보세요."
            },
            "시": {
                icon: "fas fa-heart",
                color: "category-poem",
                lightColor: "category-poem-light",
                placeholder: "마음속 감정을 시로 표현해보세요...",
                guide: "운율과 리듬을 고려하며 감정을 담아보세요."
            },
            "일기": {
                icon: "fas fa-calendar",
                color: "category-diary",
                lightColor: "category-diary-light",
                placeholder: "오늘 하루는 어땠나요?",
                guide: "솔직한 감정과 경험을 기록해보세요."
            },
            "에세이": {
                icon: "fas fa-file-alt",
                color: "category-essay",
                lightColor: "category-essay-light",
                placeholder: "주제에 대한 생각을 정리해보세요...",
                guide: "서론-본론-결론 구조로 논리적으로 전개해보세요."
            },
            "아이디어": {
                icon: "fas fa-lightbulb",
                color: "category-idea",
                lightColor: "category-idea-light",
                placeholder: "떠오른 아이디어를 빠르게 기록하세요...",
                guide: "자유롭게 생각을 펼쳐보세요. 나중에 발전시킬 수 있습니다."
            },
            "대본": {
                icon: "fas fa-theater-masks",
                color: "category-script",
                lightColor: "category-script-light",
                placeholder: "등장인물: \n대사를 작성해보세요...",
                guide: "등장인물과 대사, 지문을 명확히 구분해서 작성하세요."
            }
        };

        // 초기화
        document.addEventListener('DOMContentLoaded', function() {
            // 로컬 스토리지에서 데이터 불러오기
            const savedPieces = localStorage.getItem('writingPieces');
            if (savedPieces) {
                pieces = JSON.parse(savedPieces);
            }
            
            renderCategoryStats();
            renderPostsList();
            
            // 모바일 키보드 대응
            const inputs = document.querySelectorAll('input, textarea');
            inputs.forEach(input => {
                input.addEventListener('focus', function() {
                    if (window.innerWidth <= 640) {
                        setTimeout(() => {
                            this.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 300);
                    }
                });
            });
            
            // 터치 이벤트 최적화
            document.addEventListener('touchstart', function() {}, {passive: true});
        });

        // 로컬 스토리지에 데이터 저장
        function saveToLocalStorage() {
            localStorage.setItem('writingPieces', JSON.stringify(pieces));
        }

        // 카테고리 통계 렌더링
        function renderCategoryStats() {
            const stats = {};
            Object.keys(categoryConfig).forEach(cat => stats[cat] = 0);
            pieces.forEach(piece => stats[piece.category]++);

            const statsContainer = document.getElementById('categoryStats');
            statsContainer.innerHTML = '';

            Object.entries(categoryConfig).forEach(([category, config]) => {
                const count = stats[category];
                const isSelected = currentFilter === category;
                
                const statCard = document.createElement('div');
                statCard.className = `cursor-pointer transition-all duration-200 hover:shadow-md bg-white border border-gray-200 rounded-lg p-3 text-center touch-feedback ${isSelected ? 'ring-2 ring-blue-500' : ''}`;
                statCard.onclick = () => filterByCategory(category);
                
                statCard.innerHTML = `
                    <div class="w-8 h-8 rounded-full ${config.color} flex items-center justify-center mx-auto mb-1">
                        <i class="${config.icon} text-white"></i>
                    </div>
                    <p class="text-xs font-medium text-gray-900">${category}</p>
                    <p class="text-xs text-gray-500">${count}개</p>
                `;
                
                statsContainer.appendChild(statCard);
            });
        }

        // 작품 목록 렌더링
        function renderPostsList() {
            const filteredPieces = currentFilter === "전체" ? pieces : pieces.filter(piece => piece.category === currentFilter);
            const listContainer = document.getElementById('postsList');
            
            if (filteredPieces.length === 0) {
                listContainer.innerHTML = `
                    <div class="bg-white border border-gray-200 rounded-lg p-6 text-center">
                        <p class="text-gray-500 mb-4">${currentFilter === "전체" ? "아직 작품이 없습니다. 첫 작품을 만들어보세요!" : `${currentFilter} 작품이 없습니다.`}</p>
                        <div class="flex flex-wrap gap-2 justify-center">
                            ${Object.entries(categoryConfig).map(([category, config]) => `
                                <button onclick="startNewPiece('${category}')" class="flex items-center gap-2 px-3 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 touch-feedback">
                                    <i class="${config.icon}"></i>
                                    ${category} 쓰기
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
                return;
            }

            listContainer.innerHTML = filteredPieces.map(piece => {
                const config = categoryConfig[piece.category];
                return `
                    <div class="bg-white border border-gray-200 rounded-lg cursor-pointer hover:shadow-md transition-shadow duration-200 hover:border-gray-300 touch-feedback" onclick="editPiece('${piece.id}')">
                        <div class="p-4 pb-3">
                            <div class="flex justify-between items-start">
                                <div class="flex items-center gap-2 flex-1">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium border ${config.lightColor}">
                                        <i class="${config.icon} mr-1"></i>
                                        ${piece.category}
                                    </span>
                                    <h3 class="text-base font-semibold text-gray-900 line-clamp-2 flex-1">${piece.title}</h3>
                                </div>
                                <span class="text-xs text-gray-500 ml-2 flex-shrink-0">${piece.createdAt}</span>
                            </div>
                        </div>
                        <div class="px-4 pb-4">
                            <p class="text-sm text-gray-600 line-clamp-3 mb-2">${piece.preview}</p>
                            <div class="flex items-center gap-2 flex-wrap">
                                ${piece.mood ? `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-gray-100 text-gray-800">기분: ${piece.mood}</span>` : ''}
                                ${piece.characters && piece.characters.length > 0 ? `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-gray-100 text-gray-800">등장인물: ${piece.characters.join(', ')}</span>` : ''}
                                ${piece.tags && piece.tags.length > 0 ? piece.tags.map(tag => `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs border border-gray-300 text-gray-700">#${tag}</span>`).join('') : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 카테고리 필터링
        function filterByCategory(category) {
            if (category) {
                currentFilter = category;
                document.getElementById('categoryFilter').value = category;
            } else {
                currentFilter = document.getElementById('categoryFilter').value;
            }
            renderCategoryStats();
            renderPostsList();
        }

        // 플로팅 메뉴 토글
        function toggleFloatingMenu() {
            const button = document.getElementById('floatingButton');
            const overlay = document.getElementById('overlay');
            
            if (button.classList.contains('active')) {
                hideFloatingMenu();
            } else {
                button.classList.add('active');
                overlay.classList.remove('hidden');
            }
        }
        
        // 플로팅 메뉴 숨기기
        function hideFloatingMenu() {
            const button = document.getElementById('floatingButton');
            const overlay = document.getElementById('overlay');
            
            button.classList.remove('active');
            overlay.classList.add('hidden');
        }

        // 새 작품 시작
        function startNewPiece(category) {
            currentEditingPiece = null;
            document.getElementById('listView').classList.add('hidden');
            document.getElementById('editorView').classList.remove('hidden');
            document.getElementById('backButton').classList.remove('hidden');
            
            // 카테고리 설정
            document.getElementById('pieceCategory').value = category;
            updateEditorCategory();
            
            // 폼 초기화
            document.getElementById('pieceTitle').value = '';
            document.getElementById('pieceContent').value = '';
            document.getElementById('pieceMood').value = '';
            document.getElementById('newCharacter').value = '';
            document.getElementById('newTag').value = '';
            document.getElementById('charactersList').innerHTML = '';
            document.getElementById('tagsList').innerHTML = '';
            document.getElementById('saveButtonText').textContent = '저장';
            
            updateCharCount();
            updateCategoryVisibility();
            
            // 모바일에서 스크롤 맨 위로
            window.scrollTo(0, 0);
        }

        // 작품 편집
        function editPiece(pieceId) {
            const piece = pieces.find(p => p.id === pieceId);
            if (!piece) return;
            
            currentEditingPiece = piece;
            document.getElementById('listView').classList.add('hidden');
            document.getElementById('editorView').classList.remove('hidden');
            document.getElementById('backButton').classList.remove('hidden');
            
            // 폼에 데이터 채우기
            document.getElementById('pieceCategory').value = piece.category;
            document.getElementById('pieceTitle').value = piece.title;
            document.getElementById('pieceContent').value = piece.content;
            document.getElementById('pieceMood').value = piece.mood || '';
            document.getElementById('saveButtonText').textContent = '수정';
            
            // 등장인물과 태그 렌더링
            renderCharacters(piece.characters || []);
            renderTags(piece.tags || []);
            
            updateEditorCategory();
            updateCharCount();
            updateCategoryVisibility();
            
            // 모바일에서 스크롤 맨 위로
            window.scrollTo(0, 0);
        }

        // 편집기 카테고리 업데이트
        function updateEditorCategory() {
            const category = document.getElementById('pieceCategory').value;
            const config = categoryConfig[category];
            
            const iconElement = document.getElementById('editorCategoryIcon');
            iconElement.className = `w-10 h-10 rounded-full ${config.color} flex items-center justify-center`;
            iconElement.innerHTML = `<i class="${config.icon} text-white"></i>`;
            
            document.getElementById('editorTitle').textContent = currentEditingPiece ? `${category} 편집` : `새 ${category} 쓰기`;
            document.getElementById('editorGuide').textContent = config.guide;
            document.getElementById('pieceContent').placeholder = config.placeholder;
            
            // 대본인 경우 폰트 변경
            if (category === '대본') {
                document.getElementById('pieceContent').style.fontFamily = 'monospace';
            } else {
                document.getElementById('pieceContent').style.fontFamily = '';
            }
            
            updateCategoryVisibility();
        }

        // 카테고리별 필드 표시/숨김
        function updateCategoryVisibility() {
            const category = document.getElementById('pieceCategory').value;
            const moodSection = document.getElementById('moodSection');
            const charactersSection = document.getElementById('charactersSection');
            
            // 기분/분위기 필드
            if (category === '일기' || category === '시') {
                moodSection.style.display = 'block';
            } else {
                moodSection.style.display = 'none';
            }
            
            // 등장인물 필드
            if (category === '소설' || category === '대본') {
                charactersSection.style.display = 'block';
            } else {
                charactersSection.style.display = 'none';
            }
        }

        // 탭 전환
        function switchTab(tabName) {
            // 모든 탭 버튼과 콘텐츠 비활성화
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // 선택된 탭 활성화
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // 글자 수 업데이트
        function updateCharCount() {
            const content = document.getElementById('pieceContent').value;
            document.getElementById('charCount').textContent = `${content.length}자 작성됨`;
        }

        // 등장인물 추가
        function addCharacter() {
            const input = document.getElementById('newCharacter');
            const character = input.value.trim();
            
            if (character) {
                const currentCharacters = getCurrentCharacters();
                if (!currentCharacters.includes(character)) {
                    currentCharacters.push(character);
                    renderCharacters(currentCharacters);
                    input.value = '';
                }
            }
        }

        // 현재 등장인물 목록 가져오기
        function getCurrentCharacters() {
            const characterElements = document.querySelectorAll('#charactersList .character-tag');
            return Array.from(characterElements).map(el => el.textContent.replace(' ×', ''));
        }

        // 등장인물 렌더링
        function renderCharacters(characters) {
            const container = document.getElementById('charactersList');
            container.innerHTML = characters.map(character => `
                <span class="character-tag inline-flex items-center px-2 py-1 rounded-full text-xs bg-gray-200 text-gray-800 cursor-pointer touch-feedback" onclick="removeCharacter('${character}')">
                    ${character} ×
                </span>
            `).join('');
        }

        // 등장인물 제거
        function removeCharacter(character) {
            const currentCharacters = getCurrentCharacters().filter(c => c !== character);
            renderCharacters(currentCharacters);
        }

        // 태그 추가
        function addTag() {
            const input = document.getElementById('newTag');
            const tag = input.value.trim();
            
            if (tag) {
                const currentTags = getCurrentTags();
                if (!currentTags.includes(tag)) {
                    currentTags.push(tag);
                    renderTags(currentTags);
                    input.value = '';
                }
            }
        }

        // 현재 태그 목록 가져오기
        function getCurrentTags() {
            const tagElements = document.querySelectorAll('#tagsList .tag-item');
            return Array.from(tagElements).map(el => el.textContent.replace('#', '').replace(' ×', ''));
        }

        // 태그 렌더링
        function renderTags(tags) {
            const container = document.getElementById('tagsList');
            container.innerHTML = tags.map(tag => `
                <span class="tag-item inline-flex items-center px-2 py-1 rounded-full text-xs border border-gray-300 text-gray-700 cursor-pointer touch-feedback" onclick="removeTag('${tag}')">
                    #${tag} ×
                </span>
            `).join('');
        }

        // 태그 제거
        function removeTag(tag) {
            const currentTags = getCurrentTags().filter(t => t !== tag);
            renderTags(currentTags);
        }

        // 작품 저장
        function savePiece() {
            const title = document.getElementById('pieceTitle').value.trim();
            const content = document.getElementById('pieceContent').value.trim();
            const category = document.getElementById('pieceCategory').value;
            const mood = document.getElementById('pieceMood').value.trim();
            const characters = getCurrentCharacters();
            const tags = getCurrentTags();
            
            if (!title || !content) {
                alert('제목과 내용을 모두 입력해주세요.');
                return;
            }
            
            if (currentEditingPiece) {
                // 기존 작품 수정
                const index = pieces.findIndex(p => p.id === currentEditingPiece.id);
                pieces[index] = {
                    ...pieces[index],
                    title,
                    content,
                    preview: content.substring(0, 120) + (content.length > 120 ? '...' : ''),
                    category,
                    mood: mood || undefined,
                    characters: characters.length > 0 ? characters : undefined,
                    tags: tags.length > 0 ? tags : undefined
                };
            } else {
                // 새 작품 생성
                const newPiece = {
                    id: Date.now().toString(),
                    title,
                    content,
                    preview: content.substring(0, 120) + (content.length > 120 ? '...' : ''),
                    category,
                    createdAt: new Date().toISOString().split('T')[0],
                    mood: mood || undefined,
                    characters: characters.length > 0 ? characters : undefined,
                    tags: tags.length > 0 ? tags : undefined
                };
                pieces.unshift(newPiece);
            }
            
            // 로컬 스토리지에 저장
            saveToLocalStorage();
            
            goBackToList();
        }

        // 편집 취소
        function cancelEdit() {
            goBackToList();
        }

        // 목록으로 돌아가기
        function goBackToList() {
            document.getElementById('editorView').classList.add('hidden');
            document.getElementById('listView').classList.remove('hidden');
            document.getElementById('backButton').classList.add('hidden');
            
            currentEditingPiece = null;
            renderCategoryStats();
            renderPostsList();
        }
    </script>
</body>
</html>
